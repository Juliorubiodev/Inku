# AG_01 â€“ Risks and Fix Order

> **Author**: Auto-generated by Antigravity analysis  
> **Date**: 2026-01-09

---

## Risk Matrix

| ID | Severity | Category | Issue | Impact |
|----|----------|----------|-------|--------|
| R01 | ðŸ”´ HIGH | Security | `serviceAccountKey.json` committed in auth-service | Credential exposure |
| R02 | ðŸ”´ HIGH | Security | Upload endpoint has no auth | Anyone can upload content |
| R03 | ðŸŸ  MEDIUM | Config | Auth Dockerfile port mismatch (8003 vs 8000) | Container fails to bind |
| R04 | ðŸŸ  MEDIUM | Architecture | list-service not wired in docker-compose | Feature unavailable |
| R05 | ðŸŸ  MEDIUM | Web Migration | No CORS config on backend | Web frontend blocked |
| R06 | ðŸŸ¡ LOW | Docs | Infrastructure docs empty | Reproducibility gap |
| R07 | ðŸŸ¡ LOW | Code | MangaService missing s3 param in some calls | Runtime error possible |
| R08 | ðŸŸ¡ LOW | Deploy | No IaaS/PaaS config for Hito 5 | Grade risk |
| R09 | ðŸŸ¡ LOW | Android | Google/GitHub OAuth marked TODO | Incomplete feature |
| R10 | ðŸŸ¡ LOW | Tests | No tests for auth-service | Regression risk |

---

## Detailed Analysis

### R01: Service Account Key Committed ðŸ”´

**Location**: `backend/auth-service/serviceAccountKey.json`

**Evidence**:
```
backend/auth-service/
â”œâ”€â”€ serviceAccountKey.json     â† 2382 bytes
```

**Risk**: Firebase admin credentials in repo. If repo is public or leaked, attacker gets full Firebase access.

**Fix**:
1. Add to `.gitignore` immediately
2. Rotate the service account key in Firebase Console
3. Use secret management (GitHub Secrets + inject at runtime)

---

### R02: Upload Endpoint Without Auth ðŸ”´

**Location**: `backend/manga-service/src/inku_api/routers/uploads.py`

**Evidence**:
```python
@router.post("/{manga_id}/episodes")
def create_episode(manga_id: str, body: CreateEpisodeIn, svc: MangaService = Depends(get_service)):
    # No auth dependency!
    urls = svc.create_episode_with_presign(...)
```

**Risk**: Anyone can generate presigned S3 URLs and upload arbitrary content.

**Fix**:
1. Add auth dependency like in auth-service
2. Verify user is authorized to upload to this manga
3. Add rate limiting

---

### R03: Auth Dockerfile Port Mismatch ðŸŸ 

**Location**: `backend/auth-service/Dockerfile`

**Evidence**:
```dockerfile
EXPOSE 8000   # â† Exposes 8000

CMD ["python", "-m", "uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8003"]
# â† But runs on 8003
```

**docker-compose.yml**:
```yaml
ports:
  - "8003:8000"   # â† Maps 8003 â†’ 8000 (container)
```

**Risk**: Container runs Uvicorn on 8003, but EXPOSE and port mapping expect 8000. Currently works because docker-compose maps correctly, but inconsistent.

**Fix**: Change Dockerfile CMD to `--port 8000` for consistency.

---

### R04: list-service Not Wired ðŸŸ 

**Location**: `backend/list-service/`

**Evidence**:
- `docker-compose.yml` only defines `manga-service` and `auth-service`
- `list-service/` exists but has only stub code
- Required for "public user lists" feature

**Fix**:
1. Implement list-service with proper endpoints
2. Add to docker-compose.yml
3. Connect to Firebase for list storage

---

### R05: No CORS Configuration ðŸŸ 

**Location**: All FastAPI services

**Evidence**: No `CORSMiddleware` in any `main.py`

**Risk**: React frontend (localhost:3000) will receive `Access-Control-Allow-Origin` errors.

**Fix**:
```python
from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000", "https://inku.app"],
    allow_methods=["*"],
    allow_headers=["*"],
)
```

---

### R06: Empty Infrastructure Docs ðŸŸ¡

**Location**: 
- `infrastructure/aws/bucket-config.md` (empty)
- `infrastructure/ci-cd/pipeline-config.md` (empty)

**Fix**: Document:
- S3 bucket creation commands/Terraform
- IAM policies
- CI/CD pipeline configuration

---

### R07: MangaService Constructor Issue ðŸŸ¡

**Location**: `backend/manga-service/src/inku_api/services/manga_services.py`

**Evidence**:
```python
@dataclass
class MangaService:
    repo: MangaRepository
    s3: S3PresignService   # â† Declared in dataclass

    def __init__(self, repo):  # â† Only repo in __init__
        self.repo = repo
```

And in `mangas.py`:
```python
def get_service() -> MangaService:
    return MangaService(repo=FirestoreMangaRepo(db))  # â† No s3
```

But `uploads.py` passes both.

**Risk**: Calling `presign_read()` when s3 wasn't injected causes AttributeError.

**Fix**: Consistent injection or make s3 Optional with None default.

---

### R08: No IaaS/PaaS Config ðŸŸ¡

**Risk**: Hito 5 requires infrastructure-as-code and auto-deploy. Neither exists.

**Fix**: Create `render.yaml` or `fly.toml` and deployment workflow.

---

## Recommended Fix Order

### Phase 1: Security (Before Any Deploy) ðŸ”

| Order | Task | Est. Time |
|-------|------|-----------|
| 1.1 | Remove `serviceAccountKey.json` from repo, add to .gitignore | 10 min |
| 1.2 | Rotate Firebase service account key | 15 min |
| 1.3 | Add auth to upload endpoint | 30 min |

### Phase 2: Config Fixes (Before Docker) ðŸ”§

| Order | Task | Est. Time |
|-------|------|-----------|
| 2.1 | Fix auth-service Dockerfile port | 5 min |
| 2.2 | Add CORS middleware to both services | 15 min |
| 2.3 | Fix MangaService s3 injection | 10 min |

### Phase 3: Feature Completion ðŸ“¦

| Order | Task | Est. Time |
|-------|------|-----------|
| 3.1 | Implement list-service endpoints | 2-4 hrs |
| 3.2 | Wire list-service in docker-compose | 15 min |
| 3.3 | Add missing manga-service endpoints | 1-2 hrs |

### Phase 4: Hito 5 Compliance ðŸŽ“

| Order | Task | Est. Time |
|-------|------|-----------|
| 4.1 | Select IaaS/PaaS, document justification | 1 hr |
| 4.2 | Create platform config (render.yaml, etc.) | 30 min |
| 4.3 | Create deploy.yml workflow | 1 hr |
| 4.4 | Add observability (Sentry/Prometheus) | 2 hrs |
| 4.5 | Write performance tests | 2 hrs |
| 4.6 | Document everything in README | 1 hr |

### Phase 5: Web Migration Prep ðŸŒ

| Order | Task | Est. Time |
|-------|------|-----------|
| 5.1 | Design React app structure | 2 hrs |
| 5.2 | Create React project with Vite | 30 min |
| 5.3 | Implement auth flow (Firebase JS SDK) | 2-4 hrs |
| 5.4 | Implement manga catalog UI | 4-8 hrs |
| 5.5 | Implement PDF viewer | 2-4 hrs |
| 5.6 | Implement lists feature | 2-4 hrs |

---

## Execution Plan (8-12 Steps)

### Step 1: Security Hardening
**Definition of Done**: 
- [ ] `serviceAccountKey.json` removed and rotated
- [ ] Upload endpoint requires Bearer token
- [ ] CI passes with no secrets in repo

### Step 2: Config Alignment
**Definition of Done**:
- [ ] Auth Dockerfile uses port 8000
- [ ] docker-compose up --build starts both services
- [ ] Health checks pass on both ports

### Step 3: CORS Enable
**Definition of Done**:
- [ ] Both services have CORSMiddleware
- [ ] Test from browser console shows no CORS errors
- [ ] OPTIONS preflight returns correct headers

### Step 4: list-service MVP
**Definition of Done**:
- [ ] Endpoints: GET/POST /api/lists, POST /api/lists/{id}/mangas
- [ ] Integrated with Firestore
- [ ] Running in docker-compose on port 8002

### Step 5: IaaS Selection & Config
**Definition of Done**:
- [ ] `docs/AG_02_IAAS_SELECTION.md` complete
- [ ] `infrastructure/{platform}.yaml` created
- [ ] Can deploy with single CLI command

### Step 6: Auto-Deploy Pipeline
**Definition of Done**:
- [ ] Push to main deploys to IaaS/PaaS
- [ ] Deployment badge in README
- [ ] Live URL accessible

### Step 7: Observability Setup
**Definition of Done**:
- [ ] Sentry/Prometheus configured
- [ ] Dashboard shows metrics
- [ ] Alerts defined for errors > threshold
- [ ] `docs/AG_03_OBSERVABILITY.md` complete

### Step 8: Performance Testing
**Definition of Done**:
- [ ] k6/Locust scripts in repo
- [ ] Baseline and stress test results
- [ ] Report with charts
- [ ] `docs/AG_04_PERFORMANCE.md` complete

### Step 9: React Project Setup
**Definition of Done**:
- [ ] Vite + React project created
- [ ] Firebase JS SDK integrated
- [ ] Login/Register working
- [ ] Can call backend APIs

### Step 10: Core Web Features
**Definition of Done**:
- [ ] Manga catalog displayed
- [ ] Chapter list works
- [ ] PDF viewer embedded
- [ ] Mobile responsive

### Step 11: Lists & User Features
**Definition of Done**:
- [ ] User can create/view lists
- [ ] Add manga to list works
- [ ] Public list sharing works

### Step 12: Final Polish & Android Deprecation Plan
**Definition of Done**:
- [ ] Documentation complete
- [ ] All tests passing
- [ ] Hito 5 PR submitted
- [ ] Android migration guide written
