# AG_01 – Inku API Contract

> **Author**: Auto-generated by Antigravity analysis  
> **Date**: 2026-01-09  
> **Version**: 1.0 – Current endpoints

---

## Base URLs

| Service | Local URL | Docker URL |
|---------|-----------|------------|
| manga-service | `http://localhost:8001` | `http://manga-service:8000` |
| auth-service | `http://localhost:8003` | `http://auth-service:8000` |
| list-service | Not deployed | — |

---

## manga-service Endpoints

### Health Check

```http
GET /api/health
```

**Auth**: None  
**Response**:
```json
{
  "status": "ok"
}
```

---

### List All Mangas

```http
GET /api/mangas
```

**Auth**: None  
**Response**:
```json
[
  {
    "id": "sakamoto-days",
    "title": "Sakamoto Days",
    "description": "Un asesino retirado...",
    "cover_path": "covers/sakamoto-days.jpg",
    "recommended": "Sí",
    "tags": ["Action", "Comedy"]
  }
]
```

**Domain Model** (`Manga`):
| Field | Type | Description |
|-------|------|-------------|
| `id` | string | Document ID in Firestore |
| `title` | string | Manga title |
| `description` | string | Synopsis |
| `cover_path` | string | S3 key for cover image |
| `recommended` | string? | Recommendation flag |
| `tags` | string[] | Genre tags |

---

### List Chapters by Manga

```http
GET /api/mangas/{manga_id}/chapters
```

**Auth**: None  
**Path Params**:
- `manga_id`: Firestore document ID

**Response**:
```json
[
  {
    "id": "cap-1",
    "manga_id": "sakamoto-days",
    "number": 1,
    "pdf_path": "chapters/sakamoto-days/1.pdf",
    "thumb_path": "thumbnails/cap-1.jpg",
    "title": "El asesino más fuerte"
  }
]
```

**Error Responses**:
- `404`: `{"detail": "MANGA_NOT_FOUND"}`

**Domain Model** (`Chapter`):
| Field | Type | Description |
|-------|------|-------------|
| `id` | string | Document ID |
| `manga_id` | string | Parent manga ID |
| `number` | int | Chapter number |
| `pdf_path` | string | S3 key for PDF |
| `thumb_path` | string | S3 key for thumbnail |
| `title` | string | Chapter title |

---

### Create Episode (Upload Presign)

```http
POST /api/mangas/{manga_id}/episodes
```

**Auth**: None (⚠️ Should require auth)  
**Request Body**:
```json
{
  "episode_id": "cap-10",
  "number": 10
}
```

**Response**:
```json
{
  "manga_id": "sakamoto-days",
  "episode_id": "cap-10",
  "upload_url": "https://aws-inku-bucket.s3.eu-north-1.amazonaws.com/...",
  "pdf_key": "chapters/sakamoto-days/10.pdf"
}
```

---

## auth-service Endpoints

### Get Current User

```http
GET /api/auth/me
Authorization: Bearer <firebase_id_token>
```

**Auth**: Required (Firebase ID Token)  
**Response**: Decoded Firebase token claims
```json
{
  "uid": "abc123",
  "email": "user@example.com",
  "email_verified": true,
  "...": "other claims"
}
```

**Error Responses**:
- `401`: `{"detail": "Missing Authorization: Bearer <token>"}`
- `401`: `{"detail": "Invalid or expired Firebase token"}`

---

### Verify Token

```http
POST /api/auth/verify
Authorization: Bearer <firebase_id_token>
```

**Auth**: Required  
**Response**:
```json
{
  "uid": "abc123",
  "email": "user@example.com",
  "claims": { ... }
}
```

---

### Register (Dev Endpoint)

```http
POST /api/auth/dev/register
```

**Auth**: None  
**Request Body**:
```json
{
  "email": "user@example.com",
  "password": "securepass123"
}
```

**Response**:
```json
{
  "uid": "abc123",
  "email": "user@example.com",
  "idToken": "eyJhbGciOiJS...",
  "refreshToken": "AGEhc0A...",
  "expiresIn": "3600"
}
```

**Error Responses**:
- `400`: `{"detail": "EMAIL_EXISTS"}`
- `400`: `{"detail": "WEAK_PASSWORD"}`

---

### Login (Dev Endpoint)

```http
POST /api/auth/dev/login
```

**Auth**: None  
**Request Body**:
```json
{
  "email": "user@example.com",
  "password": "securepass123"
}
```

**Response**: Same structure as register

**Error Responses**:
- `400`: `{"detail": "EMAIL_NOT_FOUND"}`
- `400`: `{"detail": "INVALID_PASSWORD"}`

---

### Service Health

```http
GET /health
```

**Auth**: None  
**Response**:
```json
{
  "ok": true,
  "service": "auth-service"
}
```

---

## list-service Endpoints (STUB)

> ⚠️ **Not wired in docker-compose** – Only placeholder code exists

### Root

```http
GET /
```

**Response**:
```json
{
  "message": "List Service is running!"
}
```

### Get Items (Mock)

```http
GET /api/list
```

**Response**:
```json
{
  "items": [
    {"id": 1, "name": "Item A"},
    {"id": 2, "name": "Item B"}
  ]
}
```

---

## Authentication Summary

| Endpoint | Auth Required | Token Type |
|----------|---------------|------------|
| `GET /api/health` | ❌ | — |
| `GET /api/mangas` | ❌ | — |
| `GET /api/mangas/{id}/chapters` | ❌ | — |
| `POST /api/mangas/{id}/episodes` | ❌ (⚠️ should require) | — |
| `GET /api/auth/me` | ✅ | Firebase ID Token |
| `POST /api/auth/verify` | ✅ | Firebase ID Token |
| `POST /api/auth/dev/register` | ❌ | — |
| `POST /api/auth/dev/login` | ❌ | — |

---

## Firebase Token Usage

1. **Obtain token**: Call `/api/auth/dev/login` → receive `idToken`
2. **Use token**: Add header `Authorization: Bearer <idToken>`
3. **Token expiry**: 3600 seconds (1 hour)
4. **Refresh**: Use `refreshToken` with Firebase REST API

---

## CORS Configuration

**Current State**: ❌ Not configured  
**Required for Web Frontend**:
- Allow origins: `http://localhost:3000`, production domain
- Allow methods: `GET, POST, PUT, DELETE, OPTIONS`
- Allow headers: `Authorization, Content-Type`

---

## Missing Endpoints (Required for Web)

| Feature | Suggested Endpoint | Service |
|---------|-------------------|---------|
| Get manga detail | `GET /api/mangas/{id}` | manga-service |
| Presigned read URL | `GET /api/mangas/{id}/chapters/{num}/read` | manga-service |
| User lists | `GET /api/lists`, `POST /api/lists` | list-service |
| List items | `POST /api/lists/{id}/mangas` | list-service |
| User favorites | `GET /api/users/{uid}/favorites` | list-service |
| Reading progress | `PUT /api/progress/{manga_id}` | manga-service |
