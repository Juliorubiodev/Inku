# AG_01 â€“ Inku System Map

> **Author**: Auto-generated by Antigravity analysis  
> **Date**: 2026-01-09  
> **Version**: 1.0 â€“ Read-only pre-migration snapshot

---

## 1. High-Level Architecture

```mermaid
flowchart TD
    subgraph "Android Client (Current)"
        AA[Login/Register Screen]
        AB[Home Tab - Reading Progress]
        AC[Explore Tab - Manga Grid]
        AD[Upload Tab - PDF Upload]
        AE[Profile/Settings]
    end

    subgraph "React Web Client (Planned)"
        WA[Login/Register]
        WB[Dashboard/Home]
        WC[Catalog/Explore]
        WD[Upload]
        WE[Lists]
    end

    subgraph "Backend Services"
        MS[manga-service:8001]
        AS[auth-service:8003]
        LS[list-service - NOT WIRED]
    end

    subgraph "External Services"
        FB[(Firebase)]
        S3[(AWS S3)]
    end

    AA & AB & AC & AD --> MS
    AA --> AS
    WA & WB & WC & WD & WE -.-> MS
    WA -.-> AS
    MS --> FB
    MS --> S3
    AS --> FB
```

---

## 2. Component Inventory

| Component | Type | Location | Port | Status |
|-----------|------|----------|------|--------|
| **manga-service** | FastAPI microservice | `backend/manga-service/` | Host:8001 â†’ Container:8000 | âœ… Active |
| **auth-service** | FastAPI microservice | `backend/auth-service/` | Host:8003 â†’ Container:8003* | âš ï¸ Port mismatch in Dockerfile |
| **list-service** | FastAPI microservice | `backend/list-service/` | Not wired | ğŸ”´ Stub only |
| **Android App** | Kotlin/Jetpack Compose | `Inku/` | N/A | âœ… Active |
| **Firebase Firestore** | External DB | N/A | N/A | âœ… Metadata storage |
| **Firebase Auth** | External Auth | N/A | N/A | âœ… User authentication |
| **AWS S3** | External Storage | `eu-north-1` | N/A | âœ… PDF/image storage |

---

## 3. Data Flow

### 3.1 Read Manga Flow
```mermaid
sequenceDiagram
    participant Client
    participant MangaService
    participant Firestore
    participant S3

    Client->>MangaService: GET /api/mangas
    MangaService->>Firestore: Read mangas collection
    Firestore-->>MangaService: Manga metadata
    MangaService-->>Client: List<Manga>

    Client->>MangaService: GET /api/mangas/{id}/chapters
    MangaService->>Firestore: Read chapters subcollection
    Firestore-->>MangaService: Chapter metadata (pdf_path)
    MangaService-->>Client: List<Chapter>

    Note over Client,S3: To read PDF/images
    Client->>MangaService: Request presigned URL
    MangaService->>S3: Generate presigned URL
    S3-->>MangaService: Temporary URL
    MangaService-->>Client: Presigned URL
    Client->>S3: Direct download
```

### 3.2 Authentication Flow
```mermaid
sequenceDiagram
    participant Client
    participant AuthService
    participant FirebaseAuth

    Client->>AuthService: POST /api/auth/dev/register
    AuthService->>FirebaseAuth: Create user (Identity Toolkit API)
    FirebaseAuth-->>AuthService: idToken, refreshToken
    AuthService-->>Client: tokens + uid

    Client->>AuthService: POST /api/auth/dev/login
    AuthService->>FirebaseAuth: Sign in with password
    FirebaseAuth-->>AuthService: idToken, refreshToken
    AuthService-->>Client: tokens + uid

    Note over Client,AuthService: For protected endpoints
    Client->>AuthService: GET /api/auth/me (Bearer token)
    AuthService->>FirebaseAuth: Verify token (Admin SDK)
    FirebaseAuth-->>AuthService: Decoded claims
    AuthService-->>Client: User info
```

### 3.3 Upload Flow (Planned)
```mermaid
sequenceDiagram
    participant Client
    participant MangaService
    participant Firestore
    participant S3

    Client->>MangaService: POST /api/mangas/{id}/episodes
    MangaService->>Firestore: Create chapter doc
    MangaService->>S3: Generate PUT presigned URL
    MangaService-->>Client: upload_url, pdf_key

    Client->>S3: PUT PDF file (presigned URL)
    S3-->>Client: 200 OK
```

---

## 4. Firestore Data Model

```
mangas (collection)
â”œâ”€â”€ {manga_id}
â”‚   â”œâ”€â”€ title: string
â”‚   â”œâ”€â”€ description: string
â”‚   â”œâ”€â”€ cover_path: string (S3 key)
â”‚   â”œâ”€â”€ recommended: string | null
â”‚   â”œâ”€â”€ tags: array<string> | string
â”‚   â””â”€â”€ chapters (subcollection)
â”‚       â””â”€â”€ {chapter_id}
â”‚           â”œâ”€â”€ number: int
â”‚           â”œâ”€â”€ manga_id: string
â”‚           â”œâ”€â”€ title: string
â”‚           â”œâ”€â”€ pdf_path: string (S3 key)
â”‚           â””â”€â”€ thumb_path: string (S3 key)
```

---

## 5. AWS S3 Structure

**Bucket**: `aws-inku-bucket`  
**Region**: `eu-north-1`

```
aws-inku-bucket/
â”œâ”€â”€ covers/
â”‚   â””â”€â”€ {manga_id}.jpg
â”œâ”€â”€ chapters/
â”‚   â””â”€â”€ {manga_id}/
â”‚       â””â”€â”€ {chapter_number}.pdf
â”œâ”€â”€ thumbnails/
â”‚   â””â”€â”€ {chapter_id}.jpg
```

---

## 6. Environment Variables (Keys Only)

### manga-service
| Variable | Description |
|----------|-------------|
| `FIREBASE_PROJECT_ID` | Firebase project ID |
| `FIREBASE_SERVICE_ACCOUNT_FILE` | Path to service account JSON |
| `AWS_REGION` | S3 region |
| `AWS_S3_BUCKET` | S3 bucket name |
| `AWS_ACCESS_KEY_ID` | AWS access key |
| `AWS_SECRET_ACCESS_KEY` | AWS secret |
| `API_PREFIX` | Default: `/api` |
| `DEBUG` | Debug mode flag |

### auth-service
| Variable | Description |
|----------|-------------|
| `FIREBASE_SERVICE_ACCOUNT_PATH` | Path to service account JSON |
| `FIREBASE_WEB_API_KEY` | Firebase Web API key |
| `API_PREFIX` | Default: `/api` |

---

## 7. CI/CD Pipelines

| Workflow | Trigger | Purpose |
|----------|---------|---------|
| `android-ci.yml` | Push/PR to main | Lint, test, build APK |
| `publish-images.yml` | Push to main (if service changes) | Build & push Docker images to GHCR |
| `run_test.yml` | Push/PR (manga-service changes) | Run Python unit tests |

**Container Registry**: `ghcr.io/juliorubiodev/inku-{service}:latest`

---

## 8. Android App Features (Migration Requirements)

| Screen | Features | Backend Integration |
|--------|----------|---------------------|
| **Login** | Email/password, Google, GitHub (TODO), Forgot password | auth-service |
| **Register** | Email/password signup | auth-service |
| **Home** | Reading progress, Trending (mock) | manga-service (future) |
| **Explore** | Manga grid with search (TODO) | manga-service |
| **Upload** | Title, description, genre pills, PDF picker (TODO) | manga-service (presign) |
| **Profile** | User info display | auth-service |
| **Settings** | Theme, preferences | Local only |

---

## 9. Known Gaps vs Requirements

| Feature | Current State | Required for Web |
|---------|--------------|------------------|
| Public user lists | âŒ list-service is stub | âœ… Must implement |
| PDF reader | âœ… Android (PDF.js equivalent) | âœ… Need web viewer |
| Favorites | âœ… Local on Android | âœ… Need backend sync |
| Reading progress | âœ… Mock data | âœ… Need backend persistence |
| Admin moderation | âŒ Not implemented | âœ… Required |
| CORS config | âŒ Not configured | âœ… Required for web |
